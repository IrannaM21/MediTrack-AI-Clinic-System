@model OnlineClinicApplication.Models.Patient
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Patient Dashboard";
    string patientName = Model.PatientName ?? "Patient";

    Func<string, string> badgeClass = s =>
    {
        s = s == null ? "" : s.ToLower();
        if (s == "pending") return "warning";
        if (s == "confirmed") return "success";
        if (s == "booked") return "primary";
        if (s == "cancelled" || s == "canceled") return "secondary";
        return "info";
    };
}

<style>
    body { background: linear-gradient(135deg, #cce0ff, #99ccff); font-family: 'Poppins', sans-serif; }

    .dashboard { display: flex; min-height: 100vh; width: 100%; overflow-x: hidden; }

    /* Sidebar */
    .sidebar {
        position: fixed; top: 0; left: 0; height: 100vh; width: 260px;
        background: linear-gradient(180deg, #0066cc, #3399ff); color: #fff;
        padding: 18px 14px; box-shadow: 0 10px 25px rgba(0, 102, 204, 0.25); z-index: 1045;
    }
    .sidebar .brand { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
    .sidebar .welcome { color: #e8f1ff; margin-bottom: 12px; }
    .nav-links a { color: #f3f7ff; text-decoration: none; display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; transition: background .2s, transform .1s; white-space: nowrap; }
    .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.18); transform: translateX(2px); }
    .text-label { display: inline; }

    /* Desktop collapse */
    media (min-width: 992px) {
        body.sidebar-collapsed .sidebar { width: 76px; }
        body.sidebar-collapsed .sidebar .text-label { display: none; }
    }

    /* Mobile off-canvas behavior */
    media (max-width: 991.98px) {
        .sidebar { transform: translateX(-100%); transition: transform .25s ease; }
        body.sidebar-open .sidebar { transform: translateX(0); }
        .sidebar-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1040;
            opacity: 0; visibility: hidden; transition: opacity .2s, visibility .2s;
        }
        body.sidebar-open .sidebar-backdrop { opacity: 1; visibility: visible; }
    }

    /* Main */
    .main { width: 100%; margin-left: 260px; transition: margin-left .2s; }
    media (min-width: 992px) { body.sidebar-collapsed .main { margin-left: 76px; } }
    media (max-width: 991.98px) { .main { margin-left: 0; } }

    .topbar {
        position: sticky; top: 0; z-index: 10; background: #ffffffcc; backdrop-filter: blur(6px);
        border-radius: 12px; margin: 16px; padding: 10px 14px; box-shadow: 0 10px 25px rgba(0, 102, 204, 0.08);
    }

    .content-wrap { padding: 0 16px 24px 16px; }

    .card { border: none; border-radius: 16px; box-shadow: 0 10px 25px rgba(0, 102, 204, 0.12); }
    .section-title { font-weight: 700; color: #0b5ed7; }
    .stat-card { background: linear-gradient(90deg, #0066cc, #3399ff); color: #fff; }
    .stat-card h2 { font-weight: 700; margin: 0; }

    .table thead th { background: #f0f6ff; border-bottom: 0; }
    .doc-card .badge { font-weight: 500; }
</style>

<div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <i class="bi bi-hospital fs-5"></i><span class="text-label">Patient Panel</span>
        </div>
        <div class="welcome small">Welcome, <strong>@patientName</strong></div>

        <nav class="nav-links">
            <a href="#top" class="active"><i class="bi bi-speedometer2"></i><span class="text-label">Dashboard</span></a>
            <a href="#book-appointment"><i class="bi bi-calendar-plus"></i><span class="text-label">Book Appointment</span></a>
            <a href="#doctor-directory"><i class="bi bi-people-fill"></i><span class="text-label">Doctors</span></a>
            <a href="#my-appointments"><i class="bi bi-journal-medical"></i><span class="text-label">My Appointments</span></a>
            <a href="@Url.Action("Logout","Patient")"><i class="bi bi-box-arrow-right"></i><span class="text-label">Logout</span></a>
        </nav>
    </aside>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Main -->
    <main class="main">
        <div class="topbar d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <button id="sidebarToggle" type="button" class="btn btn-outline-primary me-2">
                    <i class="bi bi-list"></i>
                </button>
                <div class="fw-semibold">Patient Dashboard</div>
            </div>
            <div class="small text-muted"><i class="bi bi-person-circle me-1"></i>@patientName</div>
        </div>

        <div id="top" class="content-wrap container-fluid">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]</div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]</div>
            }

            <!-- Stats -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="card stat-card p-3 h-100">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-clipboard2-pulse fs-1 me-3"></i>
                            <div>
                                <div>Total Appointments</div>
                                <h2>@Model.TotalAppointments</h2>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-xl-3">
                    <div class="card stat-card p-3 h-100">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-calendar2-week fs-1 me-3"></i>
                            <div>
                                <div>Upcoming</div>
                                <h2>@Model.UpcomingAppointments</h2>
                            </div>
                        </div>
                    </div>
                </div>
                @if (Model.NextAppointment != null)
                {
                    var nd = Model.NextAppointment.AppointmentDate;
                    var nt = Model.NextAppointment.AppointmentTime;
                    <div class="col-12 col-xl-6">
                        <div class="card p-3 h-100">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-bell-fill text-warning fs-3 me-3"></i>
                                <div>
                                    <div class="fw-semibold">Next appointment</div>
                                    <div>
                                        Dr. @Model.NextAppointment.DoctorName (@Model.NextAppointment.Specialization) —
                                        @nd.ToString("ddd, dd MMM yyyy") at @DateTime.Today.Add(nt).ToString("hh\\:mm tt")
                                        <span class="badge bg-@badgeClass(Model.NextAppointment.Status) ms-2">@Model.NextAppointment.Status</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Book Appointment -->
            <div id="book-appointment" class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="section-title mb-0"><i class="bi bi-calendar-plus me-2"></i>Book Appointment</h5>
                        <span id="selectedDoctorLabel" class="text-muted small"></span>
                    </div>

                    @using (Html.BeginForm("BookAppointment", "Patient", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Doctor</label>
                                <select class="form-select" name="DoctorId" id="DoctorId" required>
                                    <option value="">Select Doctor</option>
                                    @if (Model.Doctors != null)
                                    {
                                        foreach (var d in Model.Doctors)
                                        {
                                            <option value="@d.DoctorId">Dr. @d.Name (@d.Specialization)</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" name="AppointmentDate" id="AppointmentDate" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-control" name="AppointmentTime" id="AppointmentTime" step="1800" min="09:00" max="18:00" required />
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check2-circle me-1"></i> Book
                            </button>
                        </div>
                        <div class="form-text mt-2">
                            Office hours 09:00–18:00. Slots are 30 minutes. If your slot is already booked, you’ll see a warning.
                        </div>
                    }
                </div>
            </div>

            <!-- Doctors -->
            <div id="doctor-directory" class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="section-title mb-0"><i class="bi bi-people-fill me-2"></i>Doctors</h5>
                        <input type="text" id="docSearch" class="form-control w-auto" placeholder="Search doctors..." />
                    </div>

                    <div class="row g-3" id="doctorGrid">
                        @if (Model.Doctors == null || Model.Doctors.Count == 0)
                        {
                            <div class="col-12">
                                <div class="alert alert-info mb-0">No doctors found.</div>
                            </div>
                        }
                        else
                        {
                            foreach (var d in Model.Doctors)
                            {
                                <div class="col-12 col-sm-6 col-lg-4 doc-card">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="me-2">
                                                    <i class="bi bi-person-badge fs-3 text-primary"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">Dr. @d.Name</div>
                                                    <div class="text-muted small">@d.Specialization</div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <span class="badge bg-light text-dark me-1"><i class="bi bi-clock me-1"></i>@d.Availability</span>
                                                <span class="badge bg-light text-dark"><i class="bi bi-currency-rupee me-1"></i>@d.ConsultationFee</span>
                                            </div>
                                            <button class="btn btn-outline-primary btn-sm book-doctor"
                                                    data-id="@d.DoctorId"
                                                    data-name="Dr. @d.Name">
                                                <i class="bi bi-calendar2-plus me-1"></i> Book
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- My Appointments -->
            <div id="my-appointments" class="card">
                <div class="card-body">
                    <h5 class="section-title mb-3"><i class="bi bi-journal-medical me-2"></i>My Appointments</h5>

                    @if (Model.Appointments == null || Model.Appointments.Count == 0)
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-1"></i> You have no appointments yet.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Doctor</th>
                                        <th>Specialization</th>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var a in Model.Appointments)
                                    {
                                        var d = a.AppointmentDate;
                                        var t = a.AppointmentTime;
                                        <tr>
                                            <td>Dr. @a.DoctorName</td>
                                            <td>@a.Specialization</td>
                                            <td>@d.ToString("dd MMM yyyy")</td>
                                            <td>@DateTime.Today.Add(t).ToString("hh\\:mm tt")</td>
                                            <td><span class="badge bg-@badgeClass(a.Status)">@a.Status</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    (function () {
        var sidebarToggle = document.getElementById('sidebarToggle');
        var backdrop = document.getElementById('sidebarBackdrop');

        function isDesktop() { return window.innerWidth >= 992; }
        function closeMobile() { document.body.classList.remove('sidebar-open'); }

        sidebarToggle.addEventListener('click', function () {
            if (isDesktop()) {
                document.body.classList.toggle('sidebar-collapsed');
            } else {
                document.body.classList.toggle('sidebar-open');
            }
        });

        if (backdrop) { backdrop.addEventListener('click', closeMobile); }

        // Close sidebar after clicking any sidebar link on mobile
        var links = document.querySelectorAll('.nav-links a');
        for (var i = 0; i < links.length; i++) {
            links[i].addEventListener('click', function () {
                if (window.innerWidth < 992) closeMobile();
            });
        }
    })();

    // Set min date to today for booking
    (function () {
        var date = document.getElementById('AppointmentDate');
        if (date) {
            var today = new Date().toISOString().split('T')[0];
            date.min = today;
        }
    })();

    // Doctor quick book button fills form
    (function () {
        var btns = document.querySelectorAll('.book-doctor');
        for (var i = 0; i < btns.length; i++) {
            btns[i].addEventListener('click', function (e) {
                e.preventDefault();
                var id = this.getAttribute('data-id');
                var name = this.getAttribute('data-name');
                var sel = document.getElementById('DoctorId');
                if (sel) {
                    sel.value = id;
                    var label = document.getElementById('selectedDoctorLabel');
                    if (label) label.textContent = 'Selected: ' + name;
                    var date = document.getElementById('AppointmentDate');
                    if (date) date.focus();
                    location.hash = '#book-appointment';
                }
            });
        }
    })();

    // Time window validation
    (function () {
        var timeInput = document.getElementById('AppointmentTime');
        if (!timeInput) return;
        function validTime(v) { return v >= '09:00' && v <= '18:00'; }
        timeInput.addEventListener('change', function () {
            if (this.value && !validTime(this.value)) {
                this.setCustomValidity('Please select a time between 09:00 and 18:00');
            } else {
                this.setCustomValidity('');
            }
        });
    })();

    // Doctor search filter
    (function () {
        var input = document.getElementById('docSearch');
        if (!input) return;
        input.addEventListener('input', function () {
            var q = this.value.toLowerCase();
            var cards = document.querySelectorAll('#doctorGrid .doc-card');
            for (var i = 0; i < cards.length; i++) {
                var text = cards[i].innerText.toLowerCase();
                cards[i].style.display = text.indexOf(q) !== -1 ? '' : 'none';
            }
        });
    })();
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">